<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Thomas Mailund" />

<meta name="date" content="2018-04-26" />

<title>Foolbox Tutorial</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">Foolbox Tutorial</h1>
<h4 class="author"><em>Thomas Mailund</em></h4>
<h4 class="date"><em>2018-04-26</em></h4>



<div id="getting-started-with-foolbox-the-function-manipulation-toolbox" class="section level1">
<h1>Getting started with foolbox, the function manipulation toolbox</h1>
<p>The <code>foolbox</code> package implements functionality for static analysis of R functions and for manipulating functions by rewriting the components they consist of. The package was written to collect similar functionality from the <a href="https://github.com/mailund/pmatch">pmatch</a> and <a href="https://github.com/mailund/tailr">tailr</a> packages, that both have functions for rewriting other functions, but is a general framework for static analysis and function rewriting.</p>
<p>The functionality centres on depth-first traversals of expression trees, typically the body of functions. For example, if you have the function <code>f</code></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  y &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  x <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">}</a></code></pre></div>
<p>then its body is an expression, a <code>call</code> to the function <code>{</code> with arguments <code>y &lt;- 2 * x</code> and <code>x + y</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">expr &lt;-<span class="st"> </span><span class="kw">body</span>(f)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">expr[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">#&gt; `{`</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">expr[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">#&gt; y &lt;- 2 * x</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">expr[[<span class="dv">3</span>]]</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">#&gt; x + y</span></a></code></pre></div>
<p>The first statement inside <code>f</code>’s body is another <code>call</code>, this time to the <code>&lt;-</code> function, and this call takes two arguments, the <code>symbol</code> <code>y</code> and the expression <code>2 * x</code> which is yet another call, to <code>*</code>, with the <code>atomic</code> 2 and <code>symbol</code> <code>x</code> as arguments.</p>
<p>With <code>foolbox</code> you can travers such expression structures and rewrite them based on callbacks. You can define callbacks for four base cases for expressions, <code>atomic</code>, <code>pairlist</code>, <code>symbol</code> and <code>primitive</code>, for the recurse <code>call</code> expressions and a callback, called <code>topdown</code>, invoked before the traversal recurses into a <code>call</code> object.</p>
<p>You specify how you want to transform an expression by composing a set of callbacks for a transformation and you apply several transformations by specifying a pipeline of these.</p>
<p>Say, for example, you have functions</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">g &lt;-<span class="st"> </span><span class="cf">function</span>(y) <span class="kw">f</span>(y)</a></code></pre></div>
<p>and you want to replace the function call <code>f(y)</code> in the body of <code>g</code> with the function body, <code>2 * x</code>. You can do this by installing a callback for calls to <code>f</code> and then rewrite with this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">callbacks &lt;-<span class="st"> </span><span class="kw">rewrite_callbacks</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="st">    </span><span class="kw">add_call_callback</span>(f, <span class="cf">function</span>(expr, ...) <span class="kw">quote</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x))</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">g <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite_with</span>(callbacks)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt; function (y) </span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#&gt; 2 * x</span></a></code></pre></div>
<p>Here, I’ve constructed the callbacks first, but a more natural approach might be to provide them inside the pipeline like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">g <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite_with</span>(</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">    <span class="kw">rewrite_callbacks</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_call_callback</span>(f, <span class="cf">function</span>(expr, ...) <span class="kw">quote</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x))</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt; function (y) </span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt; 2 * x</span></a></code></pre></div>
<p>At least, that is what I find myself doing as I am experimenting with <code>foolbox</code>.</p>
<p>If you have transformations you apply on more than one function, you can of course save them</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">subst_f &lt;-<span class="st"> </span>. <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite_with</span>(</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">    <span class="kw">rewrite_callbacks</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_call_callback</span>(f, <span class="cf">function</span>(expr, ...) <span class="kw">quote</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x))</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">)</a></code></pre></div>
<p>and apply them later</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">g <span class="op">%&gt;%</span><span class="st"> </span>subst_f</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt; function (y) </span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt; 2 * x</span></a></code></pre></div>
<p>If you have such saved transformations you can also use them as part of function definition</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">h &lt;-<span class="st"> </span>rewrites[subst_f] <span class="op">&lt;</span><span class="st"> </span><span class="cf">function</span>(x) <span class="kw">f</span>(x) <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">f</span>(x)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">h</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">#&gt; function (x) </span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co">#&gt; 2 * x + 2 * (2 * x)</span></a></code></pre></div>
<p>You can also put the full definition of a transformation in this syntax, but it is less readable.</p>
<p>The documentation is currently a bit sparse. All functions are documented, but I haven’t written documentation for the overall design. That is on its way. For now, check the examples below.</p>
<div id="installation" class="section level2">
<h2>Installation</h2>
<!--
You can install the released version of foolbox from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("foolbox")
```

And the development version from [GitHub](https://github.com/) with:
-->
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># install.packages(&quot;devtools&quot;)</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;mailund/foolbox&quot;</span>)</a></code></pre></div>
</div>
<div id="examples" class="section level2">
<h2>Examples</h2>
<p>Below are a few examples of things I thought up after writing the <code>foolbox</code>. Serendipitous discoveries that I didn’t design the package for, but that are easy to implement using it. I haven’t taken the ideas very far — it is possible to do much more with them, but that would make the exampels harder to follow.</p>
<div id="invariants" class="section level3">
<h3>Invariants</h3>
<p>Say you want to add an invariant to a variable in a function. Whenever you assign to that variable, you want to make sure the invariant is <code>TRUE</code>. We can insert invariant checking into an existing function using <code>foolbox</code>.</p>
<p>(In this example, I do not include a test at the beginning of function, which I probably should, since that requires that I check if the variable is an argument or not — with <code>foolbox</code> you can easily do this, but I keep it simple).</p>
<p>What you want to do is install an invariant that is called on all assignments, i.e. <code>call</code>s to <code>&lt;-</code> or <code>=</code>. That callback checks if the assignment is to the variable of interest, and if it is, it replaces the assignment with an assignment and a check.</p>
<p>We can write the following function for this. It expects <code>var</code> to be a symbol and <code>predicate</code> to be an expression. It creates a callback for assignments, and it then rewrites using that.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">set_invariant &lt;-<span class="st"> </span><span class="cf">function</span>(fn, var, predicate) {</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    </a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    var &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw">enexpr</span>(var)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    <span class="kw">stopifnot</span>(rlang<span class="op">::</span><span class="kw">is_symbol</span>(var))</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">    </a>
<a class="sourceLine" id="cb10-6" data-line-number="6">    predicate &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw">enexpr</span>(predicate)</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">    </a>
<a class="sourceLine" id="cb10-8" data-line-number="8">    set_invariant_callback &lt;-<span class="st"> </span><span class="cf">function</span>(expr, ...) {</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">        <span class="cf">if</span> (expr[[<span class="dv">2</span>]] <span class="op">==</span><span class="st"> </span>var) {</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">            rlang<span class="op">::</span><span class="kw">expr</span>({</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">                <span class="op">!!</span>var &lt;-<span class="st"> </span><span class="op">!!</span>expr[[<span class="dv">3</span>]]</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">                <span class="kw">stopifnot</span>(<span class="op">!!</span>predicate)</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">            })</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">        } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb10-15" data-line-number="15">            expr    </a>
<a class="sourceLine" id="cb10-16" data-line-number="16">        }</a>
<a class="sourceLine" id="cb10-17" data-line-number="17">    }</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">    </a>
<a class="sourceLine" id="cb10-19" data-line-number="19">    fn <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite_with</span>(</a>
<a class="sourceLine" id="cb10-20" data-line-number="20">        <span class="kw">rewrite_callbacks</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="st">        </span><span class="kw">add_call_callback</span>(<span class="st">`</span><span class="dt">&lt;-</span><span class="st">`</span>, set_invariant_callback) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22"><span class="st">        </span><span class="kw">add_call_callback</span>(<span class="st">`</span><span class="dt">=</span><span class="st">`</span>, set_invariant_callback)</a>
<a class="sourceLine" id="cb10-23" data-line-number="23">    )</a>
<a class="sourceLine" id="cb10-24" data-line-number="24">}</a></code></pre></div>
<p>As an example, we can require that <code>a</code> is always positive in the function below.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">    a &lt;-<span class="st"> </span>x <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">    <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>a<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>a</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">f <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_invariant</span>(a, a <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt; function (x, y) </span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="co">#&gt;     {</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co">#&gt;         a &lt;- x + y</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="co">#&gt;         stopifnot(a &gt; 0)</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co">#&gt;     2 * a^2 + a</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co">#&gt; }</span></a></code></pre></div>
<p>However, what happens if we have nested functions?</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">    a &lt;-<span class="st"> </span>x <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">    g &lt;-<span class="st"> </span><span class="cf">function</span>(a) {</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">        a &lt;-<span class="st"> </span>a <span class="op">+</span><span class="st"> </span><span class="dv">42</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">        a</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">    }</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">    h &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">        a &lt;&lt;-<span class="st"> </span><span class="op">-</span>x</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">        a<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10">    }</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">    x &lt;-<span class="st"> </span><span class="kw">h</span>(y)</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">    <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>a<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="kw">g</span>(<span class="op">-</span>x)</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb12-14" data-line-number="14"></a>
<a class="sourceLine" id="cb12-15" data-line-number="15">f <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_invariant</span>(a, a <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co">#&gt; function (x, y) </span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co">#&gt;     {</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="co">#&gt;         a &lt;- x + y</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="co">#&gt;         stopifnot(a &gt; 0)</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="co">#&gt;     g &lt;- function(a) {</span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"><span class="co">#&gt;         {</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="co">#&gt;             a &lt;- a + 42</span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25"><span class="co">#&gt;             stopifnot(a &gt; 0)</span></a>
<a class="sourceLine" id="cb12-26" data-line-number="26"><span class="co">#&gt;         }</span></a>
<a class="sourceLine" id="cb12-27" data-line-number="27"><span class="co">#&gt;         a</span></a>
<a class="sourceLine" id="cb12-28" data-line-number="28"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb12-29" data-line-number="29"><span class="co">#&gt;     h &lt;- function(x) {</span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30"><span class="co">#&gt;         a &lt;&lt;- -x</span></a>
<a class="sourceLine" id="cb12-31" data-line-number="31"><span class="co">#&gt;         a^2</span></a>
<a class="sourceLine" id="cb12-32" data-line-number="32"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33"><span class="co">#&gt;     x &lt;- h(y)</span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34"><span class="co">#&gt;     2 * a^2 + g(-x)</span></a>
<a class="sourceLine" id="cb12-35" data-line-number="35"><span class="co">#&gt; }</span></a></code></pre></div>
<p>Here, we probably don’t want to add the invariant inside the nested functions. An assignment there isn’t an assignment to the variable in the scope of <code>f</code>, after all. But we <em>do</em> want to capture <code>&lt;&lt;-</code> assignments.</p>
<p>(For the <code>&lt;&lt;-</code> assignment, it is a bit tricky to see if it is to the <code>a</code> in the scope of <code>f</code>, in general. It depends on whether that has been assigned to in <code>f</code> before we call the nested function, and in the full generality of functions, we cannot determine this before we run <code>f</code>. I am going to assume that all <code>&lt;&lt;-</code> assignments are to the scope of <code>f</code> for the rest of this example).</p>
<p>We can add <code>&lt;&lt;-</code> as a function to call our callback on, and we can use a <code>topdown</code> callback to pass information on whether we are in a nested function down the recursion.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">set_invariant &lt;-<span class="st"> </span><span class="cf">function</span>(fn, var, predicate) {</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">    </a>
<a class="sourceLine" id="cb13-3" data-line-number="3">    var &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw">enexpr</span>(var)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">    <span class="kw">stopifnot</span>(rlang<span class="op">::</span><span class="kw">is_symbol</span>(var))</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">    </a>
<a class="sourceLine" id="cb13-6" data-line-number="6">    predicate &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw">enexpr</span>(predicate)</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">    </a>
<a class="sourceLine" id="cb13-8" data-line-number="8">    set_invariant_callback &lt;-<span class="st"> </span><span class="cf">function</span>(expr, topdown, ...) {</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">        <span class="cf">if</span> (expr[[<span class="dv">2</span>]] <span class="op">==</span><span class="st"> </span>var) {</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">            <span class="cf">if</span> ( (expr[[<span class="dv">1</span>]] <span class="op">==</span><span class="st"> &quot;&lt;-&quot;</span> <span class="op">||</span><span class="st"> </span>expr[[<span class="dv">1</span>]] <span class="op">==</span><span class="st"> &quot;=&quot;</span>) <span class="op">&amp;&amp;</span><span class="st">  </span><span class="op">!</span>(topdown<span class="op">$</span>nested) ) {</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">                <span class="kw">return</span>(rlang<span class="op">::</span><span class="kw">expr</span>({</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">                    <span class="op">!!</span>var &lt;-<span class="st"> </span><span class="op">!!</span>expr[[<span class="dv">3</span>]]</a>
<a class="sourceLine" id="cb13-13" data-line-number="13">                    <span class="kw">stopifnot</span>(<span class="op">!!</span>predicate)</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">                }))</a>
<a class="sourceLine" id="cb13-15" data-line-number="15">            }</a>
<a class="sourceLine" id="cb13-16" data-line-number="16">            <span class="cf">if</span> (expr[[<span class="dv">1</span>]] <span class="op">==</span><span class="st"> '&lt;&lt;-'</span>) {</a>
<a class="sourceLine" id="cb13-17" data-line-number="17">                <span class="kw">return</span>(rlang<span class="op">::</span><span class="kw">expr</span>({</a>
<a class="sourceLine" id="cb13-18" data-line-number="18">                    <span class="op">!!</span>var &lt;&lt;-<span class="st"> </span><span class="op">!!</span>expr[[<span class="dv">3</span>]]</a>
<a class="sourceLine" id="cb13-19" data-line-number="19">                    <span class="kw">stopifnot</span>(<span class="op">!!</span>predicate)</a>
<a class="sourceLine" id="cb13-20" data-line-number="20">                }))</a>
<a class="sourceLine" id="cb13-21" data-line-number="21">            }</a>
<a class="sourceLine" id="cb13-22" data-line-number="22">        }</a>
<a class="sourceLine" id="cb13-23" data-line-number="23">        <span class="co"># if we don't return earlier, we keep the expression</span></a>
<a class="sourceLine" id="cb13-24" data-line-number="24">        expr    </a>
<a class="sourceLine" id="cb13-25" data-line-number="25">    }</a>
<a class="sourceLine" id="cb13-26" data-line-number="26">    nested_functions_callback &lt;-<span class="st"> </span><span class="cf">function</span>(expr, skip, topdown, ...) {</a>
<a class="sourceLine" id="cb13-27" data-line-number="27">        topdown<span class="op">$</span>nested &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb13-28" data-line-number="28">        topdown</a>
<a class="sourceLine" id="cb13-29" data-line-number="29">    }</a>
<a class="sourceLine" id="cb13-30" data-line-number="30">    </a>
<a class="sourceLine" id="cb13-31" data-line-number="31">    fn <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite_with</span>(</a>
<a class="sourceLine" id="cb13-32" data-line-number="32">        <span class="kw">rewrite_callbacks</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-33" data-line-number="33"><span class="st">        </span><span class="kw">add_call_callback</span>(<span class="st">`</span><span class="dt">&lt;-</span><span class="st">`</span>, set_invariant_callback) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-34" data-line-number="34"><span class="st">        </span><span class="kw">add_call_callback</span>(<span class="st">`</span><span class="dt">=</span><span class="st">`</span>, set_invariant_callback) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-35" data-line-number="35"><span class="st">        </span><span class="kw">add_call_callback</span>(<span class="st">`</span><span class="dt">&lt;&lt;-</span><span class="st">`</span>, set_invariant_callback) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-36" data-line-number="36"><span class="st">        </span><span class="kw">add_topdown_callback</span>(<span class="st">`</span><span class="dt">function</span><span class="st">`</span>, nested_functions_callback),</a>
<a class="sourceLine" id="cb13-37" data-line-number="37">        <span class="dt">topdown =</span> <span class="kw">list</span>(<span class="dt">nested=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb13-38" data-line-number="38">    )</a>
<a class="sourceLine" id="cb13-39" data-line-number="39">}</a></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">    a &lt;-<span class="st"> </span>x <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">    g &lt;-<span class="st"> </span><span class="cf">function</span>(a) {</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">        a &lt;-<span class="st"> </span>a <span class="op">+</span><span class="st"> </span><span class="dv">42</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5">        a</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">    }</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">    h &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">        a &lt;&lt;-<span class="st"> </span><span class="op">-</span>x</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">        a<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10">    }</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">    x &lt;-<span class="st"> </span><span class="kw">h</span>(y)</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">    <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>a<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="kw">g</span>(<span class="op">-</span>x)</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb14-14" data-line-number="14"></a>
<a class="sourceLine" id="cb14-15" data-line-number="15">f <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_invariant</span>(a, a <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb14-16" data-line-number="16"><span class="co">#&gt; function (x, y) </span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="co">#&gt;     {</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="co">#&gt;         a &lt;- x + y</span></a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="co">#&gt;         stopifnot(a &gt; 0)</span></a>
<a class="sourceLine" id="cb14-21" data-line-number="21"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb14-22" data-line-number="22"><span class="co">#&gt;     g &lt;- function(a) {</span></a>
<a class="sourceLine" id="cb14-23" data-line-number="23"><span class="co">#&gt;         a &lt;- a + 42</span></a>
<a class="sourceLine" id="cb14-24" data-line-number="24"><span class="co">#&gt;         a</span></a>
<a class="sourceLine" id="cb14-25" data-line-number="25"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb14-26" data-line-number="26"><span class="co">#&gt;     h &lt;- function(x) {</span></a>
<a class="sourceLine" id="cb14-27" data-line-number="27"><span class="co">#&gt;         {</span></a>
<a class="sourceLine" id="cb14-28" data-line-number="28"><span class="co">#&gt;             a &lt;&lt;- -x</span></a>
<a class="sourceLine" id="cb14-29" data-line-number="29"><span class="co">#&gt;             stopifnot(a &gt; 0)</span></a>
<a class="sourceLine" id="cb14-30" data-line-number="30"><span class="co">#&gt;         }</span></a>
<a class="sourceLine" id="cb14-31" data-line-number="31"><span class="co">#&gt;         a^2</span></a>
<a class="sourceLine" id="cb14-32" data-line-number="32"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb14-33" data-line-number="33"><span class="co">#&gt;     x &lt;- h(y)</span></a>
<a class="sourceLine" id="cb14-34" data-line-number="34"><span class="co">#&gt;     2 * a^2 + g(-x)</span></a>
<a class="sourceLine" id="cb14-35" data-line-number="35"><span class="co">#&gt; }</span></a></code></pre></div>
<p>If you want, you can add more than one invariant. The result nests some code-blocks, and it might not look pretty (you can clean it up using <code>foolbox</code> if you want), but it works.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">    a &lt;-<span class="st"> </span>x <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">    <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>a<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>a</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">f <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_invariant</span>(a, a <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_invariant</span>(a, <span class="kw">is.numeric</span>(a))</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">#&gt; function (x, y) </span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co">#&gt;     {</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="co">#&gt;         {</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="co">#&gt;             a &lt;- x + y</span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="co">#&gt;             stopifnot(is.numeric(a))</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="co">#&gt;         }</span></a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="co">#&gt;         stopifnot(a &gt; 0)</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="co">#&gt;     2 * a^2 + a</span></a>
<a class="sourceLine" id="cb15-17" data-line-number="17"><span class="co">#&gt; }</span></a></code></pre></div>
</div>
<div id="inline" class="section level3">
<h3>Inline</h3>
<p>As another example, imagine that you want to inline a function call.</p>
<p>I put some restrictions on the function in this example. I don’t allow it to have assignments. This is for the same reasons that we had to make assumptions about the <code>&lt;&lt;-</code> assignment above. We cannot, before we call the function, know what local variables will be set to. If we inline a function, we need to replace variables with values, and that gets tricky if there are assignments. For similar reasons, I will assume that default arguments can be computed from parameters that are explicitly provided. Lazy evaluation and the rules for when variables are evaluated, and in which context, makes it hard to know the values of these if I cannot assume this, and the extra analysis needed is too much for this example.</p>
<p>Anyway, with a simple mapping from a function call to its body, with variables replaced by the parameters in the call, can be implemented using two transformations. One, that replaces variables in the function body with the values they should get in the call, and another that then inserts this transformed body in the place where we have the function call.</p>
<p>I first check that the function, <code>f</code>, doesn’t have assignments. I don’t know how to check the requirements on the default arguments, but I should probably also check that.</p>
<p>After that, I define a function that maps a symbol to a value, if the symbol is found in a table, <code>map</code>. Then I use that in a function that rewrites an expression; it use the mapping function as a callback on symbols and rewrites an expression.</p>
<p>I then define a callback to inline function calls. This will be called on <code>call</code> objects for the given function. I extract the arguments provided in the call and put them in a table. Then I substitute the values in the table into the variables in the default parameters and rewrite the expressions there, substituting the variables I now have there with the values they get in the function call. Finally, I take the function body, rewrite it using the symbol map, and return that. This will then be inserted as a replacement for the function call in the depth-first traversal we set up as the final expression in the function.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">inline &lt;-<span class="st"> </span><span class="cf">function</span>(fn, f) {</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">    </a>
<a class="sourceLine" id="cb16-3" data-line-number="3">    <span class="co"># only inline if `f` has no assignments... otherwise, too much</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4">    <span class="co"># analysis is needed for this simple example.</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">    check_assignment &lt;-<span class="st"> </span><span class="cf">function</span>(expr, ...) {</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">        <span class="kw">stop</span>(<span class="st">&quot;Assignment! I told you not to!&quot;</span>)</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    }</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">    f <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">analyse</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">analyse_with</span>(</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">        <span class="kw">analysis_callbacks</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="st">            </span><span class="kw">add_topdown_callback</span>(<span class="st">`</span><span class="dt">&lt;-</span><span class="st">`</span>, check_assignment) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="st">            </span><span class="kw">add_topdown_callback</span>(<span class="st">`</span><span class="dt">=</span><span class="st">`</span>, check_assignment)</a>
<a class="sourceLine" id="cb16-12" data-line-number="12">    )</a>
<a class="sourceLine" id="cb16-13" data-line-number="13">    </a>
<a class="sourceLine" id="cb16-14" data-line-number="14">    defaults &lt;-<span class="st"> </span><span class="kw">formals</span>(f)</a>
<a class="sourceLine" id="cb16-15" data-line-number="15">    remap_symbols &lt;-<span class="st"> </span><span class="cf">function</span>(expr, map, ...) {</a>
<a class="sourceLine" id="cb16-16" data-line-number="16">        var_name &lt;-<span class="st"> </span><span class="kw">as.character</span>(expr)</a>
<a class="sourceLine" id="cb16-17" data-line-number="17">        <span class="cf">if</span> (var_name <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(map)) {</a>
<a class="sourceLine" id="cb16-18" data-line-number="18">            rlang<span class="op">::</span><span class="kw">expr</span>( ( <span class="op">!!</span>map[[var_name]] ) )</a>
<a class="sourceLine" id="cb16-19" data-line-number="19">        } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb16-20" data-line-number="20">            expr</a>
<a class="sourceLine" id="cb16-21" data-line-number="21">        }</a>
<a class="sourceLine" id="cb16-22" data-line-number="22">    }</a>
<a class="sourceLine" id="cb16-23" data-line-number="23">    remap_expr &lt;-<span class="st"> </span><span class="cf">function</span>(expr, map) {</a>
<a class="sourceLine" id="cb16-24" data-line-number="24">        expr <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite_expr</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite_expr_with</span>(</a>
<a class="sourceLine" id="cb16-25" data-line-number="25">            <span class="kw">rewrite_callbacks</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">with_symbol_callback</span>(remap_symbols),</a>
<a class="sourceLine" id="cb16-26" data-line-number="26">            <span class="dt">map =</span> map</a>
<a class="sourceLine" id="cb16-27" data-line-number="27">        )</a>
<a class="sourceLine" id="cb16-28" data-line-number="28">    }</a>
<a class="sourceLine" id="cb16-29" data-line-number="29">    </a>
<a class="sourceLine" id="cb16-30" data-line-number="30">    inline_callback &lt;-<span class="st"> </span><span class="cf">function</span>(expr, ...) {</a>
<a class="sourceLine" id="cb16-31" data-line-number="31">        map &lt;-<span class="st"> </span>defaults</a>
<a class="sourceLine" id="cb16-32" data-line-number="32">        args &lt;-<span class="st"> </span><span class="kw">as.list</span>(<span class="kw">match.call</span>(f, expr)[<span class="op">-</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb16-33" data-line-number="33">        vars &lt;-<span class="st"> </span><span class="kw">names</span>(args)</a>
<a class="sourceLine" id="cb16-34" data-line-number="34">        <span class="cf">for</span> (var <span class="cf">in</span> vars) {</a>
<a class="sourceLine" id="cb16-35" data-line-number="35">            map[[var]] &lt;-<span class="st"> </span>args[[var]]</a>
<a class="sourceLine" id="cb16-36" data-line-number="36">        }</a>
<a class="sourceLine" id="cb16-37" data-line-number="37">        <span class="cf">for</span> (var <span class="cf">in</span> <span class="kw">names</span>(defaults)) {</a>
<a class="sourceLine" id="cb16-38" data-line-number="38">            <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>var <span class="op">%in%</span><span class="st"> </span>vars) {</a>
<a class="sourceLine" id="cb16-39" data-line-number="39">                expr_with_varsubst &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">substitute</span>(defaults[[var]], map)) </a>
<a class="sourceLine" id="cb16-40" data-line-number="40">                map[[var]] &lt;-<span class="st"> </span>expr_with_varsubst <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">remap_expr</span>(map)</a>
<a class="sourceLine" id="cb16-41" data-line-number="41">            }</a>
<a class="sourceLine" id="cb16-42" data-line-number="42">        }</a>
<a class="sourceLine" id="cb16-43" data-line-number="43">        </a>
<a class="sourceLine" id="cb16-44" data-line-number="44">        <span class="kw">body</span>(f) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">remap_expr</span>(map)</a>
<a class="sourceLine" id="cb16-45" data-line-number="45">    }</a>
<a class="sourceLine" id="cb16-46" data-line-number="46">    </a>
<a class="sourceLine" id="cb16-47" data-line-number="47">    fn <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rewrite_with</span>(</a>
<a class="sourceLine" id="cb16-48" data-line-number="48">        <span class="kw">rewrite_callbacks</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-49" data-line-number="49"><span class="st">            </span><span class="kw">add_call_callback</span>(f, inline_callback)</a>
<a class="sourceLine" id="cb16-50" data-line-number="50">    )</a>
<a class="sourceLine" id="cb16-51" data-line-number="51">}</a></code></pre></div>
<p>To see it in action, we can inline the calls to <code>f</code> in the function <code>g</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">y =</span> x) <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">g &lt;-<span class="st"> </span><span class="cf">function</span>(z) <span class="kw">f</span>(z <span class="op">-</span><span class="st"> </span><span class="dv">3</span>) <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(<span class="dt">y =</span> z <span class="op">+</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">x =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">g <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">inline</span>(f)</a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="co">#&gt; function (z) </span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="co">#&gt; 2 * (z - 3) + (z - 3) + (2 * 4 + (z + 3))</span></a></code></pre></div>
<p>If we want to perform the inline-transformation while we define a new function we can use the <code>rewrites</code> syntax, but here we need to change the inline transformation function a bit. The transformations given to <code>rewrites</code> must take the function to be transformed as its first argument, so we need to “curry” the inline function, changing it from <code>function(f, fn) ...</code> to <code>function(f) function(fn) ...</code> so we can provide the function to inline in <code>rewrites</code> and get the function to transform when the <code>rewrites</code> rules are run.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">g &lt;-<span class="st"> </span>rewrites[<span class="kw">inline</span>(f)] <span class="op">&lt;</span><span class="st"> </span><span class="cf">function</span>(z) <span class="kw">f</span>(z <span class="op">-</span><span class="st"> </span><span class="dv">3</span>) <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(<span class="dt">y =</span> z <span class="op">+</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">x =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">g</a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="co">#&gt; function (z) </span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="co">#&gt; 2 * (z - 3) + (z - 3) + (2 * 4 + (z + 3))</span></a></code></pre></div>
<p>We can write <code>inline(f)</code> here, although the <code>inline</code> function takes two arguments, the first of which being the function we transform, because the <code>rewrites[...]</code> syntax transform the functions in the same was as the <code>%&gt;%</code> operator. The input to the <code>rewrites[...]</code> is automatically added as the first argument to the first transformation in <code>rewrites</code>, the output of the first transformation will be inserted as the first argument to the next transformation, etc.</p>
</div>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
